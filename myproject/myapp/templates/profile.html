<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <script src="https://cdn.tailwindcss.com"></script>
  {% load static %}
  <link rel="stylesheet" href="{% static 'style.css' %}" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const confidence = parseFloat("{{ confidence|default:0 }}") || 0;
      new Chart(document.getElementById('confidenceChart'), {
        type: 'doughnut',
        data: {
          labels: ['Confidence', 'Remaining'],
          datasets: [{
            data: [confidence, 100 - confidence],
            backgroundColor: ['#1e3a8a', '#e5e7eb'],
            borderWidth: 0
          }]
        },
        options: {
          cutout: '70%',
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          }
        }
      });
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let dropdownToggle = document.getElementById('dropdownToggle');
      let dropdownMenu = document.getElementById('dropdownMenu');
      function toggleDropdown() {
        dropdownMenu.classList.toggle('hidden');
        dropdownMenu.classList.toggle('block');
      }
      function hideDropdown() {
        dropdownMenu.classList.add('hidden');
        dropdownMenu.classList.remove('block');
      }
      dropdownToggle.addEventListener('click', (event) => {
        event.stopPropagation();
        toggleDropdown();
      });
      dropdownMenu.querySelectorAll('.dropdown-item').forEach((li) => {
        li.addEventListener('click', () => {
          hideDropdown();
        });
      });
      document.addEventListener('click', (event) => {
        if (!dropdownMenu.contains(event.target) && event.target !== dropdownToggle) {
          hideDropdown();
        }
      });
    });
  </script>
</head>
<body class="relative">
  <div class="flex flex-wrap justify-between bg-[#1e3a8a] h-auto py-4 px-8 items-center ">
    <a href="/" class="text-white text-2xl font-bold"><h1>Career<span class="text-amber-300">Pilot</span></h1></a>
    <div class="flex text-[9px] lg:text-xl md:text-xl font-medium md:flex-row gap-3 md:gap-6 text-white items-center">
      <a href="/contact_us">Contact us</a>
      <a href="{% url 'home' %}#who_we_are">Who we are</a>
      <a href="/">Home</a>
      <a href="/view_quze">Retake the Test</a>
      <div class="relative">
        <button type="button" id="dropdownToggle"
          class="px-4 py-2 flex items-center rounded-lg text-white text-sm font-medium border border-slate-300 outline-none hover:bg-slate-100/10 cursor-pointer">
          <img src="{{user.avatar.url}}" class="w-7 h-7 mr-3 rounded-full shrink-0">
          <span>{{user.last_name}}</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-3 fill-slate-400 inline ml-3" viewBox="0 0 24 24">
            <path fill-rule="evenodd"
              d="M11.99997 18.1669a2.38 2.38 0 0 1-1.68266-.69733l-9.52-9.52a2.38 2.38 0 1 1 3.36532-3.36532l7.83734 7.83734 7.83734-7.83734a2.38 2.38 0 1 1 3.36532 3.36532l-9.52 9.52a2.38 2.38 0 0 1-1.68266.69734z"
              clip-rule="evenodd" />
          </svg>
        </button>
        <ul id="dropdownMenu"
          class="absolute hidden shadow-lg bg-white py-2 z-[1000] min-w-full w-max rounded-lg max-h-96 overflow-auto">
          <li class="dropdown-item py-2.5 px-5 flex items-center hover:bg-slate-100 text-slate-600 font-medium text-sm cursor-pointer">
            <a href="/profile">View profile</a>
          </li>
          <li class="dropdown-item py-2.5 px-5 flex items-center hover:bg-slate-100 text-slate-600 font-medium text-sm cursor-pointer">
            <a href="/logout">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class=" bg-gradient-to-b from-[#1e3a8a] to-gray-800  flex flex-col lg:flex-row justify-around items-start gap-8 pt-8 px-4 {% if request.session.change_password %}blur-sm{% endif %}">
    <form action="/edit_info" method="post" enctype="multipart/form-data" class=" shadow-md bg-white  rounded border-2  shadow-white p-5 w-full max-w-md mx-auto">
      {% csrf_token %}
      <div class="relative mb-4 text-center mt-6">
        <img src="{{user.avatar.url}}" class="w-52 h-52 rounded-full object-cover border-4 mx-auto border-blue-500 shadow-lg mb-5">
        {% if request.session.toggle_form %}
        <label for="img" class="mb-2 font-semibold text-gray-700">Select image:</label>
        <input type="file" name="img" class="border border-gray-400 p-2 rounded mb-4 ">
        {% endif %}
      </div>
      <div class="flex flex-col items-center mb-4">
        <input type="text" name="first_name" value="{{user.first_name}}" placeholder="{{user.first_name}}"
          class="text-xl text-[#3457b9] font-medium text-center bg-white border mb-2"
          {% if not request.session.toggle_form %} disabled {% endif %}>
        {% if request.session.toggle_form %}
        <input type="text" name="last_name" value="{{user.last_name}}" placeholder="{{user.last_name}}"
          class="text-xl text-[#3457b9] font-medium text-center bg-white border">
        {% endif %}
      </div>
      <div class="w-full text-center mb-6">
        <h3 class="text-xl text-[#1e3a8a] font-semibold mb-4">Confidence Level</h3>
        <div class="relative w-24 h-24 mx-auto">
          <canvas id="confidenceChart" class="w-full h-full"></canvas>
          <p class="absolute inset-0 flex items-center justify-center text-[18px] font-semibold text-[#1e3a8a]">
            {{ confidence }}%
          </p>
        </div>
      </div>
      <div class="space-y-4">
        <div>
          <p class="text-[#877b7b]">Email</p>
          <input type="text" name="email" value="{{user.email}}" placeholder="{{user.email}}"
            {% if not request.session.toggle_form %} disabled {% endif %}
            class="w-full bg-white border">
        </div>
        <div>
          <p class="text-[#877b7b]">Phone number</p>
          <input type="text" name="phone" value="{{user.phone}}" placeholder="{{user.phone}}"
            {% if not request.session.toggle_form %} disabled {% endif %}
            class="w-full bg-white border">
        </div>
        <div>
          <p class="text-[#877b7b] mb-2">Place</p>
          {% if request.session.toggle_form %}
          <select name="location" id="location" required {% if not request.session.toggle_form %} disabled {% endif %}
            class="border border-gray-300 rounded-md w-full pl-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            <option value="Nablus">Nablus</option>
            <option value="Ramallah">Ramallah</option>
            <option value="Tulkarem">Tulkarem</option>
            <option value="Hebron">Hebron</option>
            <option value="Jericho">Jericho</option>
            <option value="Jenin">Jenin</option>
          </select>
          
          {% else %}
          <label   {% if not request.session.toggle_form %} disabled {% endif %}
            class="border border-gray-300 pr-10  rounded-md w-full pl-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            {{user.location}}
          </label>
          {% endif %}
        </div>
        <div>
          <p class="text-[#877b7b]">Joining date</p>
          <p>{{ user.created_at|date:"d/m/Y" }}</p>
        </div>
      </div>
      <div class="flex flex-wrap justify-center gap-4 mt-6">
        {% if not request.session.toggle_form %}
        <a href="/toggle_edit_profile" class="border-2 shadow px-5 py-2">Edit profile</a>
        <a href="/toggle_change_password" class="border-2 shadow px-5 py-2">Change Password</a>
        {% else %}
        <input type="submit" value="Confirm" class="rounded-2xl py-2 px-5 text-white bg-green-600 hover:bg-green-400">
        <a href="/toggle_edit_profile"
          class="rounded-2xl py-2 px-5 text-white bg-green-600 hover:bg-green-400">Cancel</a>
        {% endif %}
      </div>
      {% if messages %}
      <div class="max-w-md mx-auto mt-4">
        <ul class="messages">
          {% for message in messages %}
          {% if "change_info__" in message.tags %}
          <li class="text-red-500 text-sm md:text-base p-3 bg-red-50 rounded-md border border-red-200">
            {{ message }}
          </li>
          {% endif %}
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </form>

    <div class="overflow-y-auto w-full lg:w-2/4  shadow-md rounded border-2 border-[#5b73b6] shadow-[#1e3a8a]">
      <table class="w-full bg-white">
        <thead class="bg-[#1e3a8a]">
          <tr>
            <th class="p-2 text-center text-sm md:text-md font-medium text-white">Test No.</th>
            <th class="p-2 text-center text-sm md:text-md font-medium text-white">Date</th>
            <th class="p-2 text-center text-sm md:text-md font-medium text-white">Confidence Level</th>
            <th class="p-2 text-center text-sm md:text-md font-medium text-white">Career Recommendation</th>
          </tr>
        </thead>
        <tbody>
          {% for result in results %}
          <tr class="text-center text-sm md:text-base border-b-[1px]">
            <td class="font-bold"><a href="/view_result/{{result.id}}" class="text-blue-800 underline">{{result.id}}</a></td>
            <td class="font-bold">{{ result.created_at|date:"d/m/Y" }}</td>
            <td class="font-bold">{{result.confidence_level}}%</td>
            <td class="py-2 px-2 break-words">{{result.career_recommendation}}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if request.session.change_password %}
  <div class="absolute w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 rounded-2xl shadow-2xl text-xl border p-6 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-50">
    <a href="toggle_change_password" class="text-3xl absolute right-3 top-2 text-red-700 hover:text-blue-300">X</a>
    <form action="/change_password" method="post" class="space-y-4">
      {% csrf_token %}
      <div class="flex flex-col gap-2">
        <label>New Password:</label>
        <input type="password" name="new_password" class="border rounded-xl p-2">
      </div>
      <div class="flex flex-col gap-2">
        <label>Confirm Password:</label>
        <input type="password" name="confirm_password" class="border rounded-xl p-2 ">
      </div>
      <input type="submit" value="Change password"
        class="cursor-pointer border py-2 px-4 bg-green-700 hover:bg-green-500 text-white rounded-xl mx-auto block mt-6">
      {% if messages %}
      <div class="max-w-md mx-auto mt-4">
        <ul class="messages">
          {% for message in messages %}
          {% if "change_pass__" in message.tags %}
          <li class="text-red-500 text-sm md:text-base p-3 bg-red-50 rounded-md border border-red-200">
            {{ message }}
          </li>
          {% endif %}
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </form>
  </div>
  {% endif %}
</body>
</html>
